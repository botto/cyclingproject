{"ast":null,"code":"const setupModeHandler = require('./lib/mode_handler');\n\nconst getFeaturesAndSetCursor = require('./lib/get_features_and_set_cursor');\n\nconst isClick = require('./lib/is_click');\n\nconst Constants = require('./constants');\n\nconst modes = {\n  [Constants.modes.SIMPLE_SELECT]: require('./modes/simple_select'),\n  [Constants.modes.DIRECT_SELECT]: require('./modes/direct_select'),\n  [Constants.modes.DRAW_POINT]: require('./modes/draw_point'),\n  [Constants.modes.DRAW_LINE_STRING]: require('./modes/draw_line_string'),\n  [Constants.modes.DRAW_POLYGON]: require('./modes/draw_polygon'),\n  [Constants.modes.STATIC]: require('./modes/static')\n};\n\nmodule.exports = function (ctx) {\n  let mouseDownInfo = {};\n  const events = {};\n  let currentModeName = Constants.modes.SIMPLE_SELECT;\n  let currentMode = setupModeHandler(modes.simple_select(ctx), ctx);\n\n  events.drag = function (event) {\n    if (isClick(mouseDownInfo, {\n      point: event.point,\n      time: new Date().getTime()\n    })) {\n      event.originalEvent.stopPropagation();\n    } else {\n      ctx.ui.queueMapClasses({\n        mouse: Constants.cursors.DRAG\n      });\n      currentMode.drag(event);\n    }\n  };\n\n  events.mousemove = function (event) {\n    const button = event.originalEvent.buttons !== undefined ? event.originalEvent.buttons : event.originalEvent.which;\n\n    if (button === 1) {\n      return events.drag(event);\n    }\n\n    const target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n    currentMode.mousemove(event);\n  };\n\n  events.mousedown = function (event) {\n    mouseDownInfo = {\n      time: new Date().getTime(),\n      point: event.point\n    };\n    const target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n    currentMode.mousedown(event);\n  };\n\n  events.mouseup = function (event) {\n    const target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n\n    if (isClick(mouseDownInfo, {\n      point: event.point,\n      time: new Date().getTime()\n    })) {\n      currentMode.click(event);\n    } else {\n      currentMode.mouseup(event);\n    }\n  };\n\n  events.mouseout = function (event) {\n    currentMode.mouseout(event);\n  }; // 8 - Backspace\n  // 46 - Delete\n\n\n  const isKeyModeValid = code => !(code === 8 || code === 46 || code >= 48 && code <= 57);\n\n  events.keydown = function (event) {\n    if ((event.keyCode === 8 || event.keyCode === 46) && ctx.options.controls.trash) {\n      event.preventDefault();\n      currentMode.trash();\n    } else if (isKeyModeValid(event.keyCode)) {\n      currentMode.keydown(event);\n    } else if (event.keyCode === 49 && ctx.options.controls.point) {\n      changeMode(Constants.modes.DRAW_POINT);\n    } else if (event.keyCode === 50 && ctx.options.controls.line_string) {\n      changeMode(Constants.modes.DRAW_LINE_STRING);\n    } else if (event.keyCode === 51 && ctx.options.controls.polygon) {\n      changeMode(Constants.modes.DRAW_POLYGON);\n    }\n  };\n\n  events.keyup = function (event) {\n    if (isKeyModeValid(event.keyCode)) {\n      currentMode.keyup(event);\n    }\n  };\n\n  events.zoomend = function () {\n    ctx.store.changeZoom();\n  };\n\n  events.data = function (event) {\n    if (event.dataType === 'style') {\n      const {\n        setup,\n        map,\n        options,\n        store\n      } = ctx;\n      const hasLayers = !!options.styles.find(style => map.getLayer(style.id));\n\n      if (!hasLayers) {\n        setup.addLayers();\n        store.setDirty();\n        store.render();\n      }\n    }\n  };\n\n  function changeMode(modename, nextModeOptions, eventOptions = {}) {\n    currentMode.stop();\n    const modebuilder = modes[modename];\n\n    if (modebuilder === undefined) {\n      throw new Error(`${modename} is not valid`);\n    }\n\n    currentModeName = modename;\n    const mode = modebuilder(ctx, nextModeOptions);\n    currentMode = setupModeHandler(mode, ctx);\n\n    if (!eventOptions.silent) {\n      ctx.map.fire(Constants.events.MODE_CHANGE, {\n        mode: modename\n      });\n    }\n\n    ctx.store.setDirty();\n    ctx.store.render();\n  }\n\n  const actionState = {\n    trash: false,\n    combineFeatures: false,\n    uncombineFeatures: false\n  };\n\n  function actionable(actions) {\n    let changed = false;\n    Object.keys(actions).forEach(action => {\n      if (actionState[action] === undefined) throw new Error('Invalid action type');\n      if (actionState[action] !== actions[action]) changed = true;\n      actionState[action] = actions[action];\n    });\n    if (changed) ctx.map.fire(Constants.events.ACTIONABLE, {\n      actions: actionState\n    });\n  }\n\n  const api = {\n    changeMode,\n    actionable,\n    currentModeName: function () {\n      return currentModeName;\n    },\n    currentModeRender: function (geojson, push) {\n      return currentMode.render(geojson, push);\n    },\n    fire: function (name, event) {\n      if (events[name]) {\n        events[name](event);\n      }\n    },\n    addEventListeners: function () {\n      ctx.map.on('mousemove', events.mousemove);\n      ctx.map.on('mousedown', events.mousedown);\n      ctx.map.on('mouseup', events.mouseup);\n      ctx.map.on('data', events.data);\n      ctx.container.addEventListener('mouseout', events.mouseout);\n\n      if (ctx.options.keybindings) {\n        ctx.container.addEventListener('keydown', events.keydown);\n        ctx.container.addEventListener('keyup', events.keyup);\n      }\n    },\n    removeEventListeners: function () {\n      ctx.map.off('mousemove', events.mousemove);\n      ctx.map.off('mousedown', events.mousedown);\n      ctx.map.off('mouseup', events.mouseup);\n      ctx.map.off('data', events.data);\n      ctx.container.removeEventListener('mouseout', events.mouseout);\n\n      if (ctx.options.keybindings) {\n        ctx.container.removeEventListener('keydown', events.keydown);\n        ctx.container.removeEventListener('keyup', events.keyup);\n      }\n    },\n    trash: function (options) {\n      currentMode.trash(options);\n    },\n    combineFeatures: function () {\n      currentMode.combineFeatures();\n    },\n    uncombineFeatures: function () {\n      currentMode.uncombineFeatures();\n    },\n    getMode: function () {\n      return currentModeName;\n    }\n  };\n  return api;\n};","map":{"version":3,"sources":["/Users/jacquelinechen/Desktop/Mapbox/mapbox-react-tutorial/mapboxAndReact/node_modules/mapbox-gl-draw/src/events.js"],"names":["setupModeHandler","require","getFeaturesAndSetCursor","isClick","Constants","modes","SIMPLE_SELECT","DIRECT_SELECT","DRAW_POINT","DRAW_LINE_STRING","DRAW_POLYGON","STATIC","module","exports","ctx","mouseDownInfo","events","currentModeName","currentMode","simple_select","drag","event","point","time","Date","getTime","originalEvent","stopPropagation","ui","queueMapClasses","mouse","cursors","DRAG","mousemove","button","buttons","undefined","which","target","featureTarget","mousedown","mouseup","click","mouseout","isKeyModeValid","code","keydown","keyCode","options","controls","trash","preventDefault","changeMode","line_string","polygon","keyup","zoomend","store","changeZoom","data","dataType","setup","map","hasLayers","styles","find","style","getLayer","id","addLayers","setDirty","render","modename","nextModeOptions","eventOptions","stop","modebuilder","Error","mode","silent","fire","MODE_CHANGE","actionState","combineFeatures","uncombineFeatures","actionable","actions","changed","Object","keys","forEach","action","ACTIONABLE","api","currentModeRender","geojson","push","name","addEventListeners","on","container","addEventListener","keybindings","removeEventListeners","off","removeEventListener","getMode"],"mappings":"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","sourcesContent":["const setupModeHandler = require('./lib/mode_handler');\nconst getFeaturesAndSetCursor = require('./lib/get_features_and_set_cursor');\nconst isClick = require('./lib/is_click');\nconst Constants = require('./constants');\n\nconst modes = {\n  [Constants.modes.SIMPLE_SELECT]: require('./modes/simple_select'),\n  [Constants.modes.DIRECT_SELECT]: require('./modes/direct_select'),\n  [Constants.modes.DRAW_POINT]: require('./modes/draw_point'),\n  [Constants.modes.DRAW_LINE_STRING]: require('./modes/draw_line_string'),\n  [Constants.modes.DRAW_POLYGON]: require('./modes/draw_polygon'),\n  [Constants.modes.STATIC]: require('./modes/static')\n};\n\nmodule.exports = function(ctx) {\n\n  let mouseDownInfo = {};\n  const events = {};\n  let currentModeName = Constants.modes.SIMPLE_SELECT;\n  let currentMode = setupModeHandler(modes.simple_select(ctx), ctx);\n\n  events.drag = function(event) {\n    if (isClick(mouseDownInfo, {\n      point: event.point,\n      time: new Date().getTime()\n    })) {\n      event.originalEvent.stopPropagation();\n    } else {\n      ctx.ui.queueMapClasses({ mouse: Constants.cursors.DRAG });\n      currentMode.drag(event);\n    }\n  };\n\n  events.mousemove = function(event) {\n    const button = event.originalEvent.buttons !== undefined ? event.originalEvent.buttons : event.originalEvent.which;\n    if (button === 1) {\n      return events.drag(event);\n    }\n    const target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n    currentMode.mousemove(event);\n  };\n\n  events.mousedown = function(event) {\n    mouseDownInfo = {\n      time: new Date().getTime(),\n      point: event.point\n    };\n    const target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n    currentMode.mousedown(event);\n  };\n\n  events.mouseup = function(event) {\n    const target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n\n    if (isClick(mouseDownInfo, {\n      point: event.point,\n      time: new Date().getTime()\n    })) {\n      currentMode.click(event);\n    } else {\n      currentMode.mouseup(event);\n    }\n  };\n\n  events.mouseout = function(event) {\n    currentMode.mouseout(event);\n  };\n\n  // 8 - Backspace\n  // 46 - Delete\n  const isKeyModeValid = (code) => !(code === 8 || code === 46 || (code >= 48 && code <= 57));\n\n  events.keydown = function(event) {\n\n    if ((event.keyCode === 8 || event.keyCode === 46) && ctx.options.controls.trash) {\n      event.preventDefault();\n      currentMode.trash();\n    } else if (isKeyModeValid(event.keyCode)) {\n      currentMode.keydown(event);\n    } else if (event.keyCode === 49 && ctx.options.controls.point) {\n      changeMode(Constants.modes.DRAW_POINT);\n    } else if (event.keyCode === 50 && ctx.options.controls.line_string) {\n      changeMode(Constants.modes.DRAW_LINE_STRING);\n    } else if (event.keyCode === 51 && ctx.options.controls.polygon) {\n      changeMode(Constants.modes.DRAW_POLYGON);\n    }\n  };\n\n  events.keyup = function(event) {\n    if (isKeyModeValid(event.keyCode)) {\n      currentMode.keyup(event);\n    }\n  };\n\n  events.zoomend = function() {\n    ctx.store.changeZoom();\n  };\n\n  events.data = function(event) {\n    if (event.dataType === 'style') {\n      const { setup, map, options, store } = ctx;\n      const hasLayers = !!options.styles.find(style => map.getLayer(style.id));\n      if (!hasLayers) {\n        setup.addLayers();\n        store.setDirty();\n        store.render();\n      }\n    }\n  };\n\n  function changeMode(modename, nextModeOptions, eventOptions = {}) {\n    currentMode.stop();\n\n    const modebuilder = modes[modename];\n    if (modebuilder === undefined) {\n      throw new Error(`${modename} is not valid`);\n    }\n    currentModeName = modename;\n    const mode = modebuilder(ctx, nextModeOptions);\n    currentMode = setupModeHandler(mode, ctx);\n\n    if (!eventOptions.silent) {\n      ctx.map.fire(Constants.events.MODE_CHANGE, { mode: modename});\n    }\n\n    ctx.store.setDirty();\n    ctx.store.render();\n  }\n\n  const actionState = {\n    trash: false,\n    combineFeatures: false,\n    uncombineFeatures: false\n  };\n\n  function actionable(actions) {\n    let changed = false;\n    Object.keys(actions).forEach(action => {\n      if (actionState[action] === undefined) throw new Error('Invalid action type');\n      if (actionState[action] !== actions[action]) changed = true;\n      actionState[action] = actions[action];\n    });\n    if (changed) ctx.map.fire(Constants.events.ACTIONABLE, { actions: actionState });\n  }\n\n  const api = {\n    changeMode,\n    actionable,\n    currentModeName: function() {\n      return currentModeName;\n    },\n    currentModeRender: function(geojson, push) {\n      return currentMode.render(geojson, push);\n    },\n    fire: function(name, event) {\n      if (events[name]) {\n        events[name](event);\n      }\n    },\n    addEventListeners: function() {\n      ctx.map.on('mousemove', events.mousemove);\n      ctx.map.on('mousedown', events.mousedown);\n      ctx.map.on('mouseup', events.mouseup);\n      ctx.map.on('data', events.data);\n\n      ctx.container.addEventListener('mouseout', events.mouseout);\n\n      if (ctx.options.keybindings) {\n        ctx.container.addEventListener('keydown', events.keydown);\n        ctx.container.addEventListener('keyup', events.keyup);\n      }\n    },\n    removeEventListeners: function() {\n      ctx.map.off('mousemove', events.mousemove);\n      ctx.map.off('mousedown', events.mousedown);\n      ctx.map.off('mouseup', events.mouseup);\n      ctx.map.off('data', events.data);\n\n      ctx.container.removeEventListener('mouseout', events.mouseout);\n\n      if (ctx.options.keybindings) {\n        ctx.container.removeEventListener('keydown', events.keydown);\n        ctx.container.removeEventListener('keyup', events.keyup);\n      }\n    },\n    trash: function(options) {\n      currentMode.trash(options);\n    },\n    combineFeatures: function() {\n      currentMode.combineFeatures();\n    },\n    uncombineFeatures: function() {\n      currentMode.uncombineFeatures();\n    },\n    getMode: function() {\n      return currentModeName;\n    }\n  };\n\n  return api;\n};\n"]},"metadata":{},"sourceType":"script"}